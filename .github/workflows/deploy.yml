name: Deploy Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Puxa o código do repositório
      - name: Checkout code
        uses: actions/checkout@v3

      # Deploy via rsync usando a chave do secret
      - name: Deploy via rsync
        run: |
          # Cria pasta .ssh e arquivo temporário da chave privada
          mkdir -p $HOME/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" | tr -d '\r' > $HOME/.ssh/deploy_key
          chmod 600 $HOME/.ssh/deploy_key

          # Cria config SSH temporário para usar somente esta chave
          echo "Host alwaysdata
            HostName ssh-araujofj.alwaysdata.net
            User araujofj
            IdentityFile $HOME/.ssh/deploy_key
            IdentitiesOnly yes
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null" > $HOME/.ssh/config

          # Sincroniza arquivos para o servidor, ignorando .git
          rsync -avz --delete --exclude=".git" ./ alwaysdata:/home/araujofj/www/

          # Remove arquivos temporários da chave e config
          rm $HOME/.ssh/deploy_key $HOME/.ssh/config
